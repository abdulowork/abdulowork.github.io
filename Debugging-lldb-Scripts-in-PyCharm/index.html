<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Debugging lldb Scripts in PyCharm | Through the wilds of üçè dev</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Debugging lldb Scripts in PyCharm" />
<meta name="author" content="Timofey Solonin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Debugging in lldb can be great. But sometimes, running commands manually becomes tedious. Fortunately, lldb provides a way to automate any action: Python scripts! However, writing Python scripts without IDE support and a debugger is beneath any developer‚Äôs dignity. In this tutorial, I will show you how to set up PyCharm to take your lldb scripting experience to the next level. There will be: Python and PyCharm setup for lldb scripting PyCharm fix for process attachment on an arm64 macOS Python modules injection for IDE and runtime support Debugging breakpoints and commands in PyCharm" />
<meta property="og:description" content="Debugging in lldb can be great. But sometimes, running commands manually becomes tedious. Fortunately, lldb provides a way to automate any action: Python scripts! However, writing Python scripts without IDE support and a debugger is beneath any developer‚Äôs dignity. In this tutorial, I will show you how to set up PyCharm to take your lldb scripting experience to the next level. There will be: Python and PyCharm setup for lldb scripting PyCharm fix for process attachment on an arm64 macOS Python modules injection for IDE and runtime support Debugging breakpoints and commands in PyCharm" />
<link rel="canonical" href="https://abdulowork.github.io/Debugging-lldb-Scripts-in-PyCharm/" />
<meta property="og:url" content="https://abdulowork.github.io/Debugging-lldb-Scripts-in-PyCharm/" />
<meta property="og:site_name" content="Through the wilds of üçè dev" />
<meta property="og:image" content="https://abdulowork.github.io/assets/3/title_updated.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-07T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://abdulowork.github.io/assets/3/title_updated.png" />
<meta property="twitter:title" content="Debugging lldb Scripts in PyCharm" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Timofey Solonin"},"dateModified":"2023-03-07T00:00:00+00:00","datePublished":"2023-03-07T00:00:00+00:00","description":"Debugging in lldb can be great. But sometimes, running commands manually becomes tedious. Fortunately, lldb provides a way to automate any action: Python scripts! However, writing Python scripts without IDE support and a debugger is beneath any developer‚Äôs dignity. In this tutorial, I will show you how to set up PyCharm to take your lldb scripting experience to the next level. There will be: Python and PyCharm setup for lldb scripting PyCharm fix for process attachment on an arm64 macOS Python modules injection for IDE and runtime support Debugging breakpoints and commands in PyCharm","headline":"Debugging lldb Scripts in PyCharm","image":"https://abdulowork.github.io/assets/3/title_updated.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://abdulowork.github.io/Debugging-lldb-Scripts-in-PyCharm/"},"url":"https://abdulowork.github.io/Debugging-lldb-Scripts-in-PyCharm/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://abdulowork.github.io/feed.xml" title="Through the wilds of üçè dev" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-XDPHFVS0QQ"></script>
<script>
  window['ga-disable-G-XDPHFVS0QQ'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XDPHFVS0QQ');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Through the wilds of üçè dev</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Posts</a><a class="page-link" href="/talks/">Talks</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Debugging lldb Scripts in PyCharm</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-03-07T00:00:00+00:00" itemprop="datePublished">
        Mar 7, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img src="/assets/3/title_updated.png" alt="title" /></p>

<p>Debugging in <code class="language-plaintext highlighter-rouge">lldb</code> can be great. But sometimes, running commands manually becomes tedious. Fortunately, <code class="language-plaintext highlighter-rouge">lldb</code> provides a way to automate any action: <strong>Python scripts!</strong></p>

<p>However, writing <code class="language-plaintext highlighter-rouge">Python</code> scripts without IDE support and a debugger is beneath any developer‚Äôs dignity. In this tutorial, I will show you how to set up <code class="language-plaintext highlighter-rouge">PyCharm</code> to take your <code class="language-plaintext highlighter-rouge">lldb</code> scripting experience to the next level. There will be:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Python</code> and <code class="language-plaintext highlighter-rouge">PyCharm</code> setup for <code class="language-plaintext highlighter-rouge">lldb</code> scripting</li>
  <li><code class="language-plaintext highlighter-rouge">PyCharm</code> fix for process attachment on an <code class="language-plaintext highlighter-rouge">arm64</code> macOS</li>
  <li><code class="language-plaintext highlighter-rouge">Python</code> modules injection for IDE and runtime support</li>
  <li>Debugging breakpoints and commands in <code class="language-plaintext highlighter-rouge">PyCharm</code></li>
</ul>

<!--more-->

<h2 id="setting-up-pycharm">
<a href="#setting-up-pycharm" class="heading-link">
Setting up PyCharm
</a>
</h2>

<p>Let‚Äôs start by creating a directory for the project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>lldb_scripts <span class="o">&amp;&amp;</span> <span class="nb">cd </span>lldb_scripts
</code></pre></div></div>

<p>Now we need a python environment. Create a virtual environment from the Xcode‚Äôs embedded Python used by the lldb:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sh <span class="nt">-c</span> <span class="s1">'exec "$(xcode-select -p)"/Library/Frameworks/Python3.framework/Versions/Current/bin/python3 -m venv python_env'</span>
</code></pre></div></div>

<p>We also need lldb‚Äôs initialization file, so might as well link it to the project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">touch</span> ~/.lldbinit <span class="o">&amp;&amp;</span> <span class="nb">ln</span> <span class="nt">-s</span> ~/.lldbinit lldbinit
</code></pre></div></div>

<p>Open the project in PyCharm. I am on a community edition:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>open <span class="nt">-a</span> <span class="s2">"PyCharm CE"</span> <span class="nb">.</span>
</code></pre></div></div>

<p>Go to project settings and make sure the project picked up the correct virtual environment from the <code class="language-plaintext highlighter-rouge">python_env</code> directory:</p>

<p><img src="/assets/3/pycharm_environment.png" alt="pycharm_environment" /></p>

<h2 id="script-to-debug">
<a href="#script-to-debug" class="heading-link">
Script to debug
</a>
</h2>

<p>Now we need a script to debug. Make a <code class="language-plaintext highlighter-rouge">test.py</code> file with the following contents:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>  
<span class="kn">import</span> <span class="nn">time</span>  
  
<span class="k">def</span> <span class="nf">test_loop</span><span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'lldb pid is: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>  
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'The time is: </span><span class="si">{</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  
  
<span class="k">def</span> <span class="nf">__lldb_init_module</span><span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  
    <span class="n">module</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">function</span> <span class="o">=</span> <span class="n">test_loop</span><span class="p">.</span><span class="n">__name__</span>  
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">Registering </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s">. Call "</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s">" from lldb to run the script'</span><span class="p">)</span>  
    <span class="n">debugger</span><span class="p">.</span><span class="n">HandleCommand</span><span class="p">(</span><span class="sa">f</span><span class="s">'command script add -f </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">Attach to lldb at: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>

<p>And add the script import to the <code class="language-plaintext highlighter-rouge">.lldbinit</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>command script import ~/lldb_scripts/test.py
</code></pre></div></div>

<p>The script is pretty simple:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">__lldb_init_module</code> function is called when lldb is loaded</li>
  <li>The function registers the <code class="language-plaintext highlighter-rouge">test_loop</code> command in lldb</li>
  <li>Calling <code class="language-plaintext highlighter-rouge">test_loop</code> prints lldb‚Äôs pid and spins in an eternal loop printing time every 3 seconds</li>
</ol>

<p>Start <code class="language-plaintext highlighter-rouge">lldb</code> and call the <code class="language-plaintext highlighter-rouge">test_loop</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lldb <span class="nt">-o</span> test_loop
</code></pre></div></div>

<p>Hopefully, this is your output:</p>

<p><img src="/assets/3/lldb_output_1.png" alt="lldb_output_1" /></p>

<h2 id="attaching-pycharm-to-the-script">
<a href="#attaching-pycharm-to-the-script" class="heading-link">
Attaching PyCharm to the script
</a>
</h2>

<p>As always, things aren‚Äôt as simple as just running <code class="language-plaintext highlighter-rouge">Attach To Process</code> in PyCharm. <code class="language-plaintext highlighter-rouge">lldb</code> is signed to run with a hardened runtime, which means PyCharm won‚Äôt be able to attach. We need a copy of <code class="language-plaintext highlighter-rouge">lldb</code> with a stripped-down signature to bypass this restriction. Let‚Äôs make one:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cp</span> <span class="s2">"</span><span class="si">$(</span>xcrun <span class="nt">-f</span> lldb<span class="si">)</span><span class="s2">"</span> unsigned_lldb <span class="o">&amp;&amp;</span> codesign <span class="nt">--force</span> <span class="nt">--sign</span> - unsigned_lldb
</code></pre></div></div>

<p>If you made the copy outside the Xcode‚Äôs <code class="language-plaintext highlighter-rouge">bin</code> directory, the rpath would be incorrect. To run this <code class="language-plaintext highlighter-rouge">lldb</code>, we must specify rpath explicitly. Run <code class="language-plaintext highlighter-rouge">lldb</code> again using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ DYLD_FRAMEWORK_PATH</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="si">$(</span>xcode-select <span class="nt">-p</span><span class="si">))</span><span class="s2">/SharedFrameworks"</span> ./unsigned_lldb <span class="nt">-o</span> test_loop
</code></pre></div></div>

<p><img src="/assets/3/lldb_output_2.png" alt="lldb_output_2" /></p>

<p>To attach PyCharm, go to <code class="language-plaintext highlighter-rouge">Run -&gt; Attach To Process...</code> and select the pid of the lldb process (i.e., <code class="language-plaintext highlighter-rouge">5203</code> from the output above).</p>

<p>If PyCharm doesn‚Äôt show any processes go to <code class="language-plaintext highlighter-rouge">PyCharm -&gt; Preferences... -&gt; Build, Execution, Deployment -&gt; Python Debugger</code> and set the <code class="language-plaintext highlighter-rouge">Attach To Process</code> filter string to empty so that all processes are displayed.</p>

<p>On an Intel machine (or an <code class="language-plaintext highlighter-rouge">arch -x86_64 lldb</code>) PyCharm should attach and start outputting the timer in the debugger console. But many of us no longer work on Intel machines; on an arm machine, PyCharm will fail to attach.</p>

<h2 id="fixing-a-broken-arm">
<a href="#fixing-a-broken-arm" class="heading-link">
Fixing a broken arm
</a>
</h2>

<p>Attaching to arm targets, as of PyCharm 2022.3.2, <a href="https://youtrack.jetbrains.com/issue/PY-51483/Python-debugger-fails-to-launch-on-Mac-M1-Monterey-for-FastAPI-project-with-pyenv-interpreter#focus=Comments-27-6474114.0-0">isn‚Äôt supported</a> out of the box. Fortunately, the issue is <a href="https://github.com/fabioz/PyDev.Debugger/pull/201">relatively easy to workaround</a>.</p>

<p>When PyCharm connects to a process, it injects and calls a library with a C function that links the debugger to the debuggee. PyCharm bundles only the x86_64 version of that library and, on attachment, futilely tries to inject the library into an arm process.</p>

<p>To fix the attachment process, we need to compile the library to run on arm and preload it into <code class="language-plaintext highlighter-rouge">lldb</code> before PyCharm tries to call the C function from the library. The sources for the library are shipped with PyCharm and can be found in:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> <span class="s2">"/Applications/PyCharm CE.app/Contents/plugins/python-ce/helpers/pydev/pydevd_attach_to_process/linux_and_mac"</span>
</code></pre></div></div>

<p>A glance at <code class="language-plaintext highlighter-rouge">compile_mac.sh</code> reveals we need to substitute x86_64 for arm64, which should be enough to compile the library. Let‚Äôs compile and link:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g++ <span class="nt">-fPIC</span> <span class="nt">-D_REENTRANT</span> <span class="nt">-std</span><span class="o">=</span>c++11 <span class="nt">-arch</span> arm64 <span class="nt">-c</span> <span class="nt">-o</span> attach_arm64.o attach.cpp
g++ <span class="nt">-dynamiclib</span> <span class="nt">-nostartfiles</span> <span class="nt">-arch</span> arm64 <span class="nt">-o</span> attach_arm64.dylib attach_arm64.o <span class="nt">-lc</span>
</code></pre></div></div>

<p>We will use <code class="language-plaintext highlighter-rouge">dlopen</code> to preload the library straight from the <code class="language-plaintext highlighter-rouge">test.py</code> script. Add the following lines (make sure the dylib path matches your path):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">_ctypes</span>  
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">os</span>
  
<span class="k">def</span> <span class="nf">load_pydevd_library</span><span class="p">():</span>  
    <span class="n">processor</span> <span class="o">=</span> <span class="n">platform</span><span class="p">.</span><span class="n">processor</span><span class="p">()</span>  
    <span class="k">if</span> <span class="n">processor</span> <span class="o">!=</span> <span class="s">'arm'</span><span class="p">:</span>  
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'lldb is running </span><span class="si">{</span><span class="n">processor</span><span class="si">}</span><span class="s"> arch, skipping the arm fix'</span><span class="p">)</span>  
        <span class="k">return</span>  
  
    <span class="n">library_handle</span> <span class="o">=</span> <span class="n">_ctypes</span><span class="p">.</span><span class="n">dlopen</span><span class="p">(</span>  
        <span class="s">'/Applications/PyCharm CE.app/Contents/plugins/python-ce/helpers/pydev/pydevd_attach_to_process/linux_and_mac/attach_arm64.dylib'</span><span class="p">,</span>  
        <span class="n">os</span><span class="p">.</span><span class="n">RTLD_NOW</span>  
    <span class="p">)</span>  
    <span class="k">if</span> <span class="n">library_handle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
        <span class="k">print</span><span class="p">(</span><span class="s">"Library didn't load"</span><span class="p">)</span>  
        <span class="k">return</span>  
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Library handle is </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">library_handle</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  
  
    <span class="n">function</span> <span class="o">=</span> <span class="s">'DoAttach'</span>  
    <span class="n">do_attach_address</span> <span class="o">=</span> <span class="n">_ctypes</span><span class="p">.</span><span class="n">dlsym</span><span class="p">(</span><span class="n">library_handle</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>  
    <span class="k">if</span> <span class="n">do_attach_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Couldn't find </span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s"> in library at </span><span class="si">{</span><span class="n">library_handle</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  
        <span class="k">return</span>  
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s"> loaded at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">do_attach_address</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  
  
<span class="n">load_pydevd_library</span><span class="p">()</span>
</code></pre></div></div>

<p>If you now run <code class="language-plaintext highlighter-rouge">lldb</code>, the library handle and the <code class="language-plaintext highlighter-rouge">DoAttach</code> function address will print out:</p>

<p><img src="/assets/3/lldb_output_3.png" alt="lldb_output_3" /></p>

<p>And attaching in PyCharm should finally work as expected:</p>

<p><img src="/assets/3/pycharm_1.png" alt="pycharm_1" /></p>

<p>PyCharm still tries to inject the Intel library, but everything works out since we preloaded the <code class="language-plaintext highlighter-rouge">DoAttach</code> function.</p>

<h2 id="working-in-pycharm">
<a href="#working-in-pycharm" class="heading-link">
Working in PyCharm
</a>
</h2>

<p><strong>UPD:</strong> I was originally using <code class="language-plaintext highlighter-rouge">pydevd.settrace()</code> to break execution. Actually there is need no call pydevd API directly, just set a breakpoint in PyCharm and execution will break as usual.</p>

<details>
  <summary>But here is how you could tinkerer with pydevd directly from lldb</summary>

  <p>The issue is that neither the project in PyCharm, where we work on the script, nor lldb, where the script executes, know anything about <code class="language-plaintext highlighter-rouge">pydevd</code> APIs. If we stick <code class="language-plaintext highlighter-rouge">import pydevd</code> into the script, nothing works:</p>

  <p><img src="/assets/3/lldb_output_4.png" alt="lldb_output_4" /></p>

  <p>Let‚Äôs first fix the lldb runtime. On my <code class="language-plaintext highlighter-rouge">PyCharm CE</code> pydevd is located in:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Applications/PyCharm CE.app/Contents/plugins/python-ce/helpers/pydev
</code></pre></div>  </div>

  <p>To make the <code class="language-plaintext highlighter-rouge">pydevd</code> module accessible to the lldb runtime, we need to add this directory to the python module search paths using the  <code class="language-plaintext highlighter-rouge">sys.path</code> API. Try adding the following lines at the beginning of <code class="language-plaintext highlighter-rouge">test.py</code>:</p>

  <p><img src="/assets/3/pydevd.png" alt="lldb_output_4" /></p>

  <p>The <code class="language-plaintext highlighter-rouge">lldb -o test_loop</code> command is working again!</p>

  <p>To make PyCharm aware of the API do:</p>

  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/Applications/PyCharm CE.app/Contents/plugins/python-ce/helpers/pydev'</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">echo </span>python_env/lib/python<span class="k">*</span><span class="si">)</span><span class="s2">/site-packages/pydev.pth"</span>
</code></pre></div>  </div>

  <p>We can now <code class="language-plaintext highlighter-rouge">import pydevd</code>. Go to the <code class="language-plaintext highlighter-rouge">test_loop</code> function and rewrite it to:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/Applications/PyCharm CE.app/Contents/plugins/python-ce/helpers/pydev'</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">lldb</span> <span class="kn">import</span> <span class="n">SBDebugger</span><span class="p">,</span> <span class="n">SBCommandReturnObject</span>  
<span class="kn">from</span> <span class="nn">pydevd</span> <span class="kn">import</span> <span class="n">settrace</span>  
  
<span class="k">def</span> <span class="nf">test_loop</span><span class="p">(</span>  
    <span class="n">debugger</span><span class="p">:</span> <span class="n">SBDebugger</span><span class="p">,</span>  
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  
    <span class="n">result</span><span class="p">:</span> <span class="n">SBCommandReturnObject</span><span class="p">,</span>  
    <span class="nb">dict</span>  
<span class="p">):</span>  
    <span class="n">settrace</span><span class="p">()</span>  
    <span class="k">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>  
    <span class="k">print</span><span class="p">(</span><span class="n">debugger</span><span class="p">.</span><span class="n">GetSelectedTarget</span><span class="p">())</span>  
    <span class="n">result</span><span class="p">.</span><span class="n">AppendWarning</span><span class="p">(</span><span class="sa">f</span><span class="s">'Warning from </span><span class="si">{</span><span class="n">test_loop</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  
    <span class="k">print</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p><br /></p>

<p>Now that all platforms are attachable, we need to make PyCharm aware of the <code class="language-plaintext highlighter-rouge">lldb</code> API. One way to do that is to create a <code class="language-plaintext highlighter-rouge">pth</code> pointer in the <code class="language-plaintext highlighter-rouge">site-packages</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="si">$(</span>xcode-select <span class="nt">-p</span><span class="si">))</span><span class="s2">"</span>/SharedFrameworks/LLDB.framework/Versions/A/Resources/Python <span class="o">&gt;</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">echo </span>python_env/lib/python<span class="k">*</span><span class="si">)</span><span class="s2">/site-packages/lldb.pth"</span>
</code></pre></div></div>

<p>Finally, <code class="language-plaintext highlighter-rouge">import lldb</code> works, and we are able to explore the API with proper code-completions.</p>

<p>To attach to this script, do the following steps:</p>
<ol>
  <li>Launch <code class="language-plaintext highlighter-rouge">lldb</code></li>
  <li>Attach PyCharm to the <code class="language-plaintext highlighter-rouge">lldb</code> process</li>
  <li>Set a breakpoint</li>
  <li>Call the command from <code class="language-plaintext highlighter-rouge">lldb</code></li>
</ol>

<p>PyCharm will break at the breakpoint. This is what it should look like:</p>

<p><img src="/assets/3/pycharm_debugging_updated.png" alt="pycharm_left" /></p>

<p><img src="/assets/3/lldb_debugging_updated.png" alt="lldb_right" /></p>

<p>üéâ</p>

<h2 id="scripting-examples">
<a href="#scripting-examples" class="heading-link">
Scripting examples
</a>
</h2>

<p>With the might of PyCharm in our hands, let‚Äôs slap together some useful scripts.</p>

<p>How about <a href="https://gist.github.com/abdulowork/98ee0d9170e949488c508390ce81cb4f">this one</a> for automating the <a href="https://abdulowork.github.io/Hacking-Finder-with-lldb-and-Hopper/">Finder hack</a>?</p>

<video preload="auto" muted="" controls="" width="100%">
  <source src="/assets/3/browse_packages.mp4" type="video/mp4" />
  <source src="/assets/3/browse_packages.webm" type="video/webm" />
</video>

<p>In addition to commands, it is also possible to script breakpoints. Let‚Äôs <a href="https://gist.github.com/abdulowork/d61303baf22b6d0feb469f12f949b1f9">dump an image</a> of a view any time <code class="language-plaintext highlighter-rouge">viewDidAppear</code> is called by reading a pointer from the Objective-C method and generating a Swift expression using Python.</p>

<video preload="auto" muted="" controls="" width="100%">
  <source src="/assets/3/scripting_breakpoint.mp4" type="video/mp4" />
  <source src="/assets/3/scripting_breakpoint.webm" type="video/webm" />
</video>

<p>Amazing!</p>

  </div><script src="https://giscus.app/client.js"
          data-repo="abdulowork/abdulowork.github.io"
          data-repo-id="R_kgDOHQRyQg"
          data-category="Announcements"
          data-category-id="DIC_kwDOHQRyQs4CPAeZ"
          data-mapping="og:title"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="top"
          data-theme="transparent_dark"
          data-lang="en"
          crossorigin="anonymous"
          async>
  </script>

  <a class="u-url" href="/Debugging-lldb-Scripts-in-PyCharm/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Timofey Solonin</li>
          <li><a class="u-email" href="mailto:abdulowork@gmail.com">abdulowork@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Writing about the experience with Apple development tools</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/abdulowork" target="_blank" title="abdulowork"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://stackoverflow.com/users/6407425" target="_blank" title="6407425"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/timofey-solonin" target="_blank" title="timofey-solonin"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/abdulowork" target="_blank" title="abdulowork"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
